<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€é˜…è¯»å™¨</title>
    <style>
        :root {
            --bg-color: #f7f7f7;
            --paper-color: #ffffff;
            --text-color: #333333;
            --accent-color: #5d5d5d;
            --sidebar-bg: #eeeeee;
            --sidebar-hover: #e0e0e0;
            --active-toc-bg: rgba(0,0,0,0.08); /* ç›®å½•é«˜äº®èƒŒæ™¯ */
            --status-bg: rgba(255, 255, 255, 0.9);
            --status-text: #666;
            --font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            --font-size: 18px;
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            overflow: hidden; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- é¡¶éƒ¨æ§åˆ¶æ  --- */
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--paper-color);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: background 0.3s;
        }

        .brand-area { display: flex; align-items: center; gap: 15px; }
        .toggle-btn { font-size: 24px; cursor: pointer; padding: 5px; border-radius: 4px; color: var(--text-color); }
        .toggle-btn:hover { background: var(--sidebar-hover); }
        .brand { font-weight: bold; font-size: 1.1em; color: var(--text-color); }
        .controls { display: flex; gap: 10px; align-items: center; }

        button, select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            color: #333;
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            background: #444;
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .file-upload:hover { background: #666; }
        .file-upload input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }

        /* --- ä¸»å¸ƒå±€ --- */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }

        /* --- å·¦ä¾§ç›®å½•æ  --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid rgba(0,0,0,0.05);
            overflow-y: auto;
            flex-shrink: 0;
            transition: margin-left 0.3s ease, background 0.3s;
        }
        .sidebar.collapsed { margin-left: calc(var(--sidebar-width) * -1); }

        .toc-list { list-style: none; padding: 0; margin: 0; padding-bottom: 50px;}
        .toc-item {
            padding: 14px 18px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-color);
            transition: background 0.2s;
            line-height: 1.5;
            border-left: 4px solid transparent; /* é¢„ç•™è¾¹æ¡†ä½ç½® */
        }
        .toc-item:hover { background-color: var(--sidebar-hover); color: var(--accent-color); font-weight: 500; }
        
        /* ç›®å½•æ¿€æ´»çŠ¶æ€æ ·å¼ */
        .toc-active { 
            background-color: var(--active-toc-bg); 
            font-weight: bold; 
            border-left: 4px solid var(--accent-color); 
            color: var(--accent-color);
        }
        
        .toc-empty { padding: 20px; color: #999; text-align: center; font-size: 14px; }

        /* --- å³ä¾§é˜…è¯»åŒº --- */
        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0;
            background-color: var(--bg-color);
            scroll-behavior: smooth;
        }

        .paper {
            max-width: 800px;
            margin: 40px auto;
            padding: 60px;
            background-color: var(--paper-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            min-height: 80vh;
            border-radius: 4px;
            transition: background 0.3s;
            position: relative;
        }

        #content {
            font-size: var(--font-size);
            line-height: 1.8;
            text-align: justify;
            white-space: pre-wrap;
        }

        .chapter-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 2.5em;
            margin-bottom: 1em;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
            color: var(--text-color);
            display: block;
        }

        /* --- åº•éƒ¨çŠ¶æ€æ  --- */
        .status-bar {
            position: fixed;
            bottom: 20px;
            right: 30px;
            background: var(--status-bg);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none;
            gap: 15px;
            align-items: center;
            color: var(--status-text);
            z-index: 200;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.05);
            user-select: none;
        }
        
        .status-item { display: flex; align-items: center; }
        .status-divider { color: #ccc; font-size: 10px; }

        #welcome { text-align: center; margin-top: 100px; color: #888; }
        
        .theme-btn { 
            width: 20px; height: 20px; border-radius: 50%; border: 1px solid #ccc; 
            cursor: pointer; display: inline-block; transition: transform 0.2s;
        }
        .theme-btn:hover { transform: scale(1.2); }

        /* å¤œé—´æ¨¡å¼é€‚é… */
        .dark-mode .toolbar { background: #1f1f1f; border-bottom: 1px solid #333; }
        .dark-mode button, .dark-mode select { background: #333; border-color: #444; color: #ccc; }
        .dark-mode .sidebar { background: #1a1a1a; border-right: 1px solid #333; }
        .dark-mode .toc-item { border-bottom: 1px solid #2a2a2a; }
        .dark-mode .toc-item:hover { background: #2c2c2c; }
        .dark-mode .status-bar { border: 1px solid #333; }

        @media (max-width: 768px) {
            .sidebar { position: absolute; height: 100%; z-index: 99; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
            .paper { padding: 20px; width: 95%; margin: 20px auto; padding-bottom: 100px; }
            .controls button, .controls select { display: none; }
            .controls .file-upload, .controls .theme-group { display: inline-block; }
            .status-bar { right: 10px; bottom: 10px; font-size: 12px; padding: 6px 12px; max-width: 90%; }
            .status-bookname { display: none; }
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="brand-area">
            <div class="toggle-btn" onclick="toggleSidebar()" title="åˆ‡æ¢ç›®å½•">â˜°</div>
            <div class="brand">æç®€é˜…è¯»å™¨</div>
        </div>
        <div class="controls">
            <div class="file-upload">
                <span>ğŸ“‚ å¯¼å…¥TXT</span>
                <input type="file" id="fileInput" accept=".txt">
            </div>
            
            <select id="fontSelector" onchange="changeFont()">
                <option value="'PingFang SC', 'Microsoft YaHei', sans-serif">é»‘ä½“</option>
                <option value="'Songti SC', 'SimSun', 'STSong', serif">å®‹ä½“</option>
                <option value="'KaiTi', 'æ¥·ä½“', 'STKaiti', 'åæ–‡æ¥·ä½“', serif">æ¥·ä½“</option>
            </select>
            <button onclick="adjustSize(-1)">A-</button>
            <button onclick="adjustSize(1)">A+</button>

            <div class="theme-group" style="display:flex; gap:8px; margin-left:10px;">
                <div class="theme-btn" style="background:#fff;" onclick="setTheme('light')" title="çº¯å‡€ç™½"></div>
                <div class="theme-btn" style="background:#C7EDCC;" onclick="setTheme('green')" title="æŠ¤çœ¼ç»¿"></div>
                <div class="theme-btn" style="background:#f4ecd8;" onclick="setTheme('sepia')" title="ç¾Šçš®çº¸"></div>
                <div class="theme-btn" style="background:#121212;" onclick="setTheme('dark')" title="å¤œé—´"></div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <div id="toc-container" class="toc-list">
                <div class="toc-empty">æš‚æ— ç›®å½•</div>
            </div>
        </div>

        <div class="content-area" id="contentArea">
            <div class="paper">
                <div id="welcome">
                    <h2>è¯·å¯¼å…¥ä¹¦ç±</h2>
                    <p>ç‚¹å‡»å³ä¸Šè§’â€œå¯¼å…¥TXTâ€</p>
                </div>
                <div id="content"></div>
            </div>
        </div>
    </div>

    <div id="statusBar" class="status-bar">
        <span class="status-item status-bookname" id="statusBookName">æ— ä¹¦å</span>
        <span class="status-divider status-bookname">|</span>
        <span class="status-item" id="statusChapter">ç¬¬ 0 / 0 ç« </span>
        <span class="status-divider">|</span>
        <span class="status-item" id="statusProgress">0%</span>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const contentDiv = document.getElementById('content');
        const tocContainer = document.getElementById('toc-container');
        const contentArea = document.getElementById('contentArea');
        const sidebar = document.getElementById('sidebar');
        const statusBar = document.getElementById('statusBar');
        const root = document.documentElement;

        let currentSize = 18;
        let totalChapters = 0;
        let chapterPositions = [];
        let lastActiveChapter = 0; // ç”¨äºé¿å…é‡å¤åˆ·æ–°UI

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const bookName = file.name.replace(/\.[^/.]+$/, "");
            document.getElementById('statusBookName').innerText = bookName;
            document.title = bookName + " - é˜…è¯»ä¸­";

            document.getElementById('welcome').style.display = 'none';
            contentDiv.innerHTML = '<div style="text-align:center;color:#999;margin-top:50px;">æ­£åœ¨è§£æä¹¦ç±...</div>';
            
            const reader = new FileReader();
            reader.readAsText(file, 'UTF-8'); 

            reader.onload = function(e) {
                setTimeout(() => processText(e.target.result), 50);
            };
        });

        function processText(text) {
            let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            let tocHtml = '';
            totalChapters = 0;
            
            const regex = /(^\s*ç¬¬[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ]+[ç« å·èŠ‚].*$)/gm;
            
            const formattedContent = safeText.replace(regex, function(match) {
                totalChapters++;
                const id = 'chapter-' + totalChapters;
                const cleanTitle = match.trim();
                // å¢åŠ äº† id="toc-X" ä»¥ä¾¿åç»­æŸ¥æ‰¾
                tocHtml += `<li class="toc-item" id="toc-${totalChapters}" onclick="jumpTo('${id}', ${totalChapters})">${cleanTitle}</li>`;
                return `<span id="${id}" class="chapter-title" data-index="${totalChapters}">${match}</span>`;
            });

            contentDiv.innerHTML = formattedContent;

            if (tocHtml) {
                tocContainer.innerHTML = tocHtml;
            } else {
                tocContainer.innerHTML = '<div class="toc-empty">æœªæ£€æµ‹åˆ°ç« èŠ‚ç›®å½•</div>';
            }

            statusBar.style.display = 'flex';
            
            // é‡ç½®çŠ¶æ€
            lastActiveChapter = 0;
            setTimeout(() => {
                cacheChapterPositions();
                updateStatus();
            }, 100);
            
            contentArea.scrollTop = 0;
            if(window.innerWidth < 768) sidebar.classList.add('collapsed');
        }

        function cacheChapterPositions() {
            chapterPositions = [];
            const titles = document.querySelectorAll('.chapter-title');
            titles.forEach(el => {
                chapterPositions.push({
                    top: el.offsetTop,
                    index: parseInt(el.getAttribute('data-index'))
                });
            });
        }

        contentArea.addEventListener('scroll', function() {
            window.requestAnimationFrame(updateStatus);
        });

        function updateStatus() {
            if(totalChapters === 0) return;

            const scrollTop = contentArea.scrollTop;
            const scrollHeight = contentArea.scrollHeight;
            const clientHeight = contentArea.clientHeight;

            // 1. è®¡ç®—é˜…è¯»ç™¾åˆ†æ¯”
            let percent = 0;
            if(scrollHeight > clientHeight) {
                percent = Math.round((scrollTop / (scrollHeight - clientHeight)) * 100);
            }
            document.getElementById('statusProgress').innerText = percent + "%";

            // 2. æŸ¥æ‰¾å½“å‰æ‰€åœ¨ç« èŠ‚
            let currentIdx = 1;
            // åç§»é‡ 150pxï¼šå½“æ ‡é¢˜è¿›å…¥å±å¹•é¡¶éƒ¨åŒºåŸŸæ—¶å³è§†ä¸ºè¿›å…¥è¯¥ç« 
            const offset = 150; 
            
            for (let i = 0; i < chapterPositions.length; i++) {
                if (scrollTop + offset >= chapterPositions[i].top) {
                    currentIdx = chapterPositions[i].index;
                } else {
                    break;
                }
            }
            
            document.getElementById('statusChapter').innerText = `ç¬¬ ${currentIdx} / ${totalChapters} ç« `;

            // 3. é«˜äº®ç›®å½• (ä»…å½“ç« èŠ‚å˜åŒ–æ—¶æ‰æ‰§è¡ŒDOMæ“ä½œï¼Œä¼˜åŒ–æ€§èƒ½)
            if (currentIdx !== lastActiveChapter) {
                highlightSidebar(currentIdx);
                lastActiveChapter = currentIdx;
            }
        }

        function highlightSidebar(index) {
            // ç§»é™¤æ—§çš„é«˜äº®
            const activeItems = document.querySelectorAll('.toc-active');
            activeItems.forEach(el => el.classList.remove('toc-active'));

            // æ·»åŠ æ–°çš„é«˜äº®
            const newItem = document.getElementById('toc-' + index);
            if (newItem) {
                newItem.classList.add('toc-active');
                // è‡ªåŠ¨æ»šåŠ¨ç›®å½•ï¼Œç¡®ä¿å½“å‰ç« èŠ‚å¯è§ (block: 'nearest' ä½“éªŒæœ€å¥½)
                newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function jumpTo(id, index) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // ç§»åŠ¨ç«¯ç‚¹å‡»åæ”¶èµ·ä¾§æ 
                if(window.innerWidth < 768) toggleSidebar();
                // ç«‹å³è§¦å‘é«˜äº®ï¼Œä¸è¦ç­‰æ»šåŠ¨äº‹ä»¶
                highlightSidebar(index);
                lastActiveChapter = index; 
            }
        }

        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
        }

        function adjustSize(delta) {
            currentSize = Math.max(12, Math.min(36, currentSize + delta));
            root.style.setProperty('--font-size', currentSize + 'px');
            setTimeout(cacheChapterPositions, 500); 
        }

        function changeFont() {
            root.style.setProperty('--font-family', document.getElementById('fontSelector').value);
            setTimeout(cacheChapterPositions, 500);
        }

        function setTheme(theme) {
            document.body.classList.remove('dark-mode');
            
            if (theme === 'light') {
                root.style.setProperty('--bg-color', '#f7f7f7');
                root.style.setProperty('--paper-color', '#ffffff');
                root.style.setProperty('--text-color', '#333333');
                root.style.setProperty('--sidebar-bg', '#eeeeee');
                root.style.setProperty('--sidebar-hover', '#e0e0e0');
                root.style.setProperty('--active-toc-bg', 'rgba(0,0,0,0.08)');
                root.style.setProperty('--status-bg', 'rgba(255, 255, 255, 0.9)');
                root.style.setProperty('--status-text', '#666');
            } 
            else if (theme === 'green') { 
                root.style.setProperty('--bg-color', '#dcecd2');
                root.style.setProperty('--paper-color', '#C7EDCC');
                root.style.setProperty('--text-color', '#2f362f');
                root.style.setProperty('--sidebar-bg', '#d1e3c7'); 
                root.style.setProperty('--sidebar-hover', '#c2d6b6');
                root.style.setProperty('--active-toc-bg', 'rgba(0,0,0,0.05)');
                root.style.setProperty('--status-bg', 'rgba(199, 237, 204, 0.9)');
                root.style.setProperty('--status-text', '#2f362f');
            }
            else if (theme === 'sepia') {
                root.style.setProperty('--bg-color', '#f2eecb');
                root.style.setProperty('--paper-color', '#fdf6e3');
                root.style.setProperty('--text-color', '#5b4636');
                root.style.setProperty('--sidebar-bg', '#e8e4c1');
                root.style.setProperty('--sidebar-hover', '#dcd8b8');
                root.style.setProperty('--active-toc-bg', 'rgba(0,0,0,0.05)');
                root.style.setProperty('--status-bg', 'rgba(253, 246, 227, 0.9)');
                root.style.setProperty('--status-text', '#5b4636');
            } 
            else if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                root.style.setProperty('--bg-color', '#121212');
                root.style.setProperty('--paper-color', '#1e1e1e');
                root.style.setProperty('--text-color', '#b0b0b0');
                root.style.setProperty('--sidebar-bg', '#1a1a1a');
                root.style.setProperty('--sidebar-hover', '#2c2c2c');
                root.style.setProperty('--active-toc-bg', 'rgba(255,255,255,0.1)');
                root.style.setProperty('--status-bg', 'rgba(30, 30, 30, 0.9)');
                root.style.setProperty('--status-text', '#aaa');
            }
        }
    </script>
</body>
</html>